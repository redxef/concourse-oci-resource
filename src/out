#!/usr/bin/env sh

set -eu

[ -e /opt/resource/common ] && cd /opt/resource
. ./common

IMAGE_REFS_FILE="$(mktemp -t)"
oci_dir="$(mktemp -d)"
cd "$oci_dir"
tar xf "$1/$(jq -r .params.image < "$INPUT_FILE")"
cd - 1>&2
crane push "$oci_dir" "$REPOSITORY:$TAG" --image-refs="$IMAGE_REFS_FILE"
jq --null-input --arg version "$(sed 's/^[^@]*@//' < "$IMAGE_REFS_FILE")" '$version'
